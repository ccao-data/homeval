<!doctype html>
<html lang="en">
<head>
  {{ partial "head/boilerplate.html" . }}

  {{ partial "head/css-link-bootstrap.html" . }}

  <!-- Load Bootstrap icons -->
  <link rel="stylesheet" href="/static/css/bootstrap-icons@1.13.1.min.css" />

  <!-- Load Leaflet CSS -->
  <link rel="stylesheet" href="/static/css/leaflet@1.9.4.css" />

  <!-- Load Reactable equivalent (DataTables) CSS -->
  <link rel="stylesheet" href="/static/css/datatables@2.3.2.min.css" />

  {{ partial "head/favicons.html" . }}

  {{ partial "head/styles.html" . }}
</head>
<body>
  {{ partial "banner/banner.html" . }}

  <!-- Body of the report -->
  <div class="container">

    <div class="card-body">
      <!-- Search again button that returns user to homepage -->
      <p>
        {{- /* Determine the search‑page URL based on environment */ -}}
        {{ $search_href := cond (eq .Params.environment "prod") "." "https://stage-drupal.ccaotest.com/model-valuation" }}
        <a href="{{ $search_href }}" class="text-decoration-none fw-semibold">
          <i class="bi bi-arrow-left"></i> Back to Search
        </a>
      </p>

      <p>
        The goal of this report is to explain how the Cook County Assessor’s statistical
        model estimated the value of the home with Parcel Identification Number
        (PIN) <strong>{{ .Params.pin_pretty }}</strong> in tax year
        <strong>{{ .Params.assessment_year }}</strong>. The Assessor’s model used past home
        sales and property characteristics to learn about the real estate market
        leading up to {{ .Params.assessment_year }}. Then, it used what it learned to
        estimate what this home could have sold for on <strong>January 1,
        {{ .Params.assessment_year }}</strong> if it had sold on that date in a fair, open-market transaction.
      </p>
      <div class="info-box border">
        <div
          class="info-header text-white p-3 d-flex"
          data-bs-toggle="collapse"
          data-bs-target="#info-content"
          aria-expanded="true"
          aria-controls="info-content"
        >
          <h5 class="mb-0">
            <i id="info-caret" class="bi bi-caret-down-fill"></i>
            Click to read more about this report
          </h5>
        </div>

        <div class="collapse" id="info-content">
          <div class="p-3 bg-light">
            <h5>What is the Assessor's model?</h5>
            <p>
              The Assessor’s “statistical model” is a computer program that uses
              past home sales to estimate current prices. The model combines past
              sales with “characteristics” that the Assessor collects about every
              home in Cook County over time, like square footage and location.
            </p>
            <p>
              By combining sale prices and characteristics, the model “learns”
              how characteristics like square footage have influenced sale prices
              in the past. It also learns patterns in how these prices have changed
              over time. It uses these patterns from the past to estimate sale prices on
              January 1, {{ .Params.assessment_year }}.
            </p>
            <h5>How does the Assessor use the model to value my home?</h5>
            <p>
              Once per year, the Assessor uses the model to make a first
              estimate for the value of all single-family homes and small
              multi-family buildings in the portion of Cook County that is
              up for reassessment. In {{ .Params.assessment_year }}, the
              Assessor used the model to generate these estimates on
              {{ .Params.final_model_run_date }}.
            </p>
            <p>
              After using the model to generate estimates, analysts at the
              Assessor's Office review them by hand to make sure they are
              correct. Once the Assessor's analysts are confident in the
              corrected values, the Assessor mails them to homeowners.
            </p>
            <p>
              Due to the Assessor's review process, the model estimates are
              often not exactly the same as the values that the Assessor mails
              to homeowners.
            </p>
            <h5>What information does this report contain?</h5>
            <p>
              The Assessor’s model uses sales reported by the Illinois Department of Revenue.
              Before analyzing sale trends, the model removes a small number of sales that the
              Assessor believes were not fair, open-market transactions. This includes sales
              between family members, distressed sales, and foreclosure auctions, among others.
            </p>
            <p>
              This report compares your home to 5 past sales that the model found to
              be most important for your estimated home value in {{ .Params.assessment_year }}.
              The top of the report shows the location and characteristics of your home. The
              middle section of the report compares the location and characteristics of the
              top five sales to your home’s location and characteristics. At the end,
              the report summarizes the prices of the top five sales and compares them
              to your home’s estimated value.
            </p>
            <p>
              If you have a background in statistics or computer science, you might be
              interested in our article
              <a href="https://ccao-data.github.io/lightsnip/articles/finding-comps.html" target="_blank">
                Finding comparables with LightGBM
              </a>.
              This article provides technical details about how we used the model to
              find the top five most important sales for every home.
            </p>
          </div>
        </div>
      </div>

      <h2 class="mb-3">About Your Home</h2>
      <p>
        The tables below show some basic facts about your home
        in tax year {{ .Params.assessment_year }}.
      </p>

      {{ $is_multicard := gt .Params.meta_pin_num_cards 1 }}

      {{ if $is_multicard }}
        <div class="alert alert-primary">
          <p>
            <i class="bi bi-info-circle"></i>
            Your home has multiple "cards", which is an assessment term for a
            building or an improvement on a property.
            Each card on a property can have different characteristics.
            {{ if not .Params.special_case_multi_card }}
              To account for these differences, the Assessor's model estimates
              different values for each card.
            {{ end }}
            Toggle between the tabs below to view characteristics
            {{ if not .Params.special_case_multi_card }}
              and similar sales
            {{ end }}
            for each card.
          </p>
        </div>
      {{ end }}

      <!-- Report contents. This is structured differently depending on whether the parcel is multicard. -->
      {{ if $is_multicard }}
        <!-- Multicard: Create a tab for each card to show its characteristics -->
        <ul class="nav nav-tabs" id="propertyCardTabs" role="tablist">
          {{ range $index, $card := .Params.cards }}
          <li class="nav-item" role="presentation">
            <button
              class="nav-link {{ if eq $index 0 }}active{{ end }}"
              id="card-{{ $index }}-tab"
              data-bs-toggle="tab"
              data-bs-target="#card-{{ $index }}"
              type="button"
              role="tab"
              aria-controls="card-{{ $index }}"
              aria-selected="{{ if eq $index 0 }}true{{ else }}false{{ end }}"
            >
              Card {{ $card.card_num }}
            </button>
          </li>
          {{ end }}
        </ul>

        <div class="tab-content mb-3" id="propertyCardTabContent">
          {{ range $index, $card := .Params.cards }}
          <div
            class="tab-pane fade {{ if eq $index 0 }}show active{{ end }}"
            id="card-{{ $index }}"
            role="tabpanel"
            aria-labelledby="card-{{ $index }}-tab"
          >
            {{
              template "card-characteristics"
              (dict
                "card" $card
                "Params" $.Params
                "is_multicard" true
                "special_case_multi_card" $.Params.special_case_multi_card
              )
            }}

            {{ if not $.Params.special_case_multi_card }}
              {{
                template "card-comps"
                (dict
                  "card" $card
                  "Params" $.Params
                  "is_multicard" true
                  "special_case_multi_card" false
                )
              }}
            {{ end }}
          </div>
          {{ end }}
        </div>

        {{/*
          Use the global store for frankencard assignment so that we can update
          it within the scope of conditional branches and loops below
        */}}
        {{ $.Store.Set "frankencard" false }}

        {{ if .Params.special_case_multi_card }}
          {{/*
            Extract frankencard to use as base for comps and values in the
            small recent multicard case
          */}}
          {{ range .Params.cards }}
            {{ if .is_frankencard }}
              {{ $.Store.Set "frankencard" . }}
            {{ end }}
          {{ end }}

          {{ $frankencard := $.Store.Get "frankencard" }}

          {{ if not $frankencard }}
            {{
              errorf
              "No card with is_frankencard == true found in .Params.cards for small multicard PIN %q"
              .Params.pin
            }}
          {{ else }}
            {{
              template "card-comps"
              (dict
                "card" $frankencard
                "Params" $.Params
                "is_multicard" true
                "special_case_multi_card" true
              )
            }}
          {{ end }}
        {{ end }}

      {{ else }}
        <!-- Single-card: No tabs required -->
        {{ $card := index .Params.cards 0 }}
        {{
          template "card-characteristics"
          (dict
            "card" $card
            "Params" $.Params
            "is_multicard" false
            "special_case_multi_card" false
          )
        }}
        {{
          template "card-comps"
          (dict
            "card" $card
            "Params" $.Params
            "is_multicard" false
            "special_case_multi_card" false
          )
        }}
      {{ end }}

      <h3>Final Model Estimate</h3>
      <p>
        After rounding and other processing, the model's final estimate for the value of your home
        on lien date <strong>January 1st, {{ .Params.assessment_year }}</strong> was
        <strong>{{ .Params.pred_pin_final_fmv_round }}</strong>.
      </p>
      <div class="alert alert-warning">
        <p>
          <i class="bi bi-exclamation-triangle-fill"></i>
          The model's estimated value for your home is not necessarily the final valuation during a
          reassessment. Analysts at the Assessor's Office can review the model's estimate and make
          adjustments. To see your home's most recent valuation, visit the
          <a href="https://www.cookcountyassessor.com/pin/{{ .Params.pin }}" class="alert-link" target="_blank">Assessor's website</a>.
        </p>
      </div>
      <p>
        <a
          href="#banner"
          type="button"
          class="btn btn-outline-dark"
        >
          <i class="bi bi-arrow-bar-up" aria-hidden="true"></i> Back to top
        </a>
      </p>

    </div>
  </div>

  {{/* Define a template for high-level card characteristics */}}
  {{ define "card-characteristics" }}

  <!-- Wrap Location and Characteristics tables in a row so they appear side-by-side on desktop -->
  <div class="row">
    <div class="col-12 col-lg-6">
      <h3 class="mb-3">Location</h3>
      <div class="table-responsive">
        <table class="table table-bordered location-table">
          <tbody>
            <tr>
              <td><strong>Address</strong></td>
              <td>{{ .card.location.property_address }}</td>
            </tr>
            <tr>
              <td><strong>Municipality</strong></td>
              <td>{{ .card.location.municipality }}</td>
            </tr>
            <tr>
              <td><strong>Assessor Township</strong></td>
              <td>{{ .card.location.township }}</td>
            </tr>
            <tr>
              <td><strong>Assessor Neighborhood Code</strong></td>
              <td>{{ .card.location.meta_nbhd_code }}</td>
            </tr>
            <tr>
              <td><strong>Elementary School District</strong></td>
              <td>{{ .card.location.loc_school_elementary_district_name }}</td>
            </tr>
            <tr>
              <td><strong>High School District</strong></td>
              <td>{{ .card.location.loc_school_secondary_district_name }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <h3 class="mb-3">Top Characteristics</h3>
      <div class="table-responsive">
        <table class="table table-bordered characteristic-table">
          <tbody>
            <tr>
              <td><strong>Property Type</strong></td>
              <td>{{ .card.char_class_detailed }}</td>
            </tr>
            <tr>
              <td><strong>Year Built</strong></td>
              <td>{{ .card.chars.char_yrblt }}</td>
            </tr>
            <tr>
              <td><strong>Building Square Footage</strong></td>
              <td>{{ .card.chars.char_bldg_sf }}</td>
            </tr>
            <tr>
              <td><strong>Land Square Footage</strong></td>
              <td>{{ .card.chars.char_land_sf }}</td>
            </tr>
            <tr>
              <td><strong>Number of Beds</strong></td>
              <td>{{ .card.chars.char_beds }}</td>
            </tr>
            <tr>
              <td><strong>Number of Full Baths</strong></td>
              <td>{{ .card.chars.char_fbath }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {{ end }}

  {{/* Define a template for the comps map */}}
  {{ define "card-comps" }}

  <!-- Comp map -->
  <h2 class="mb-3">Top 5 Most Important Sales</h2>
  <p>
    This map shows your home alongside the five sales that were most important
    for the model's estimation of your home value.
  </p>
  <p>
    <i class="bi bi-hand-index-thumb" aria-hidden="true"></i>
    Tap or click on a home or a sale to see more details about it.
  </p>
  <div
    id="map-{{ .card.card_num }}"
    class="map-container"
  >
  </div>

  <!-- Comp chars -->
  <h3
    class="mt-4"
    id="sale-characteristics-{{ .card.card_num }}"
  >
    Characteristics for Top 5 Most Important Sales
  </h3>
  <p>
    "Characteristics" are data points about a home that help the model
    compare it to recent sales. This table shows all of the characteristics
    that the model used to estimate your home value alongside the
    characteristics for the top five sales. Each characteristic has a score
    from one to three stars (<i style="font-size:0.9em" class="bi bi-star-fill text-muted"></i>)
    indicating how important it was for the model's estimate.
  </p>
  <div class='d-lg-none'>
    <p>
      <i class='bi-hand-index-thumb'></i>
      Click on a characteristic below to expand the row and show all five sales.
    </p>
  </div>
  <div class="mb-3">
    <table
      class="table table-striped table-hover display characteristic-comparison-table"
      id="comp-table-{{ .card.card_num }}"
    >
      <thead>
        <tr>
          <th data-orderable="false">Characteristic</th>
          <th data-orderable="true" id="comp-table-score-col-{{ .card.card_num }}">
            Score
          </th>
          <th data-orderable="false">
            Your home{{ if .special_case_multi_card }}<span class="asterisk">*</span>{{ end }}
          </th>
          {{ range $index, $comp := .card.comps }}
          <th data-orderable="false">
            Sale {{ $comp.comp_num }}{{ if $comp.is_subject_pin_sale }}<span class="asterisk">**</span>{{ end }}
          </th>
          {{ end }}
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="char-name">Sale Price</td>
          <td></td>
          <td></td>
          {{ range $index, $comp := .card.comps }}
          <td>{{ $comp.sale_price }}</td>
          {{ end }}
        </tr>
        <tr>
          <td class="char-name">Sale $/sqft</td>
          <td></td>
          <td></td>
          {{ range $index, $comp := .card.comps }}
          <td>{{ $comp.sale_price_per_sq_ft }}</td>
          {{ end }}
        </tr>
        <tr>
          <td class="char-name">Sale Date</td>
          <td></td>
          <td></td>
          {{ range $index, $comp := .card.comps }}
          <td>{{ $comp.sale_date }}</td>
          {{ end }}
        </tr>
        <tr>
          <td class="char-name">Sale Doc. Num.</td>
          <td></td>
          <td></td>
          {{ range $comp := $.card.comps }}
            <td>{{ $comp.document_num }}</td>
          {{ end }}
        </tr>
        <tr>
          <td class="char-name">Address</td>
          <td></td>
          <td>{{ $.card.location.property_address }}</td>
          {{ range $comp := $.card.comps }}
            <td>{{ $comp.property_address }}</td>
          {{ end }}
        </tr>
        <tr>
          <td class="char-name">PIN</td>
          <td></td>
          <td>
            <a href="https://www.cookcountyassessor.com/pin/{{ .Params.pin }}" target="_blank">
              {{ .card.pin_pretty }}
            </a>
          </td>
          {{ range $comp := $.card.comps }}
            <td>
              <a href="https://www.cookcountyassessor.com/pin/{{ $comp.pin }}" target="_blank">
                {{ $comp.pin_pretty }}
              </a>
            </td>
          {{ end }}
        </tr>
        <!-- Predictors -->
        {{ range $char := .card.predictors }}
        <tr>
          <td class="char-name">{{ index $.Params.var_labels $char }}</td>
          {{ $char_terc := index $.card.char_terciles $char }}
          <td>
            {{ if or (eq $char_terc "1") (eq $char_terc "2") (eq $char_terc "3") }}
              <span class="d-none" aria-hidden="true">{{ $char_terc }}</span>
              {{ range seq (int $char_terc) }}<i style="font-size:0.9em" class="bi bi-star-fill text-muted"></i>{{ end }}
            {{ else }}
              {{/* Currently no-op to support old reports; enable if we go live with this approach */}}
              {{/*
                errorf
                "Got unexpected value for characteristic tercile for feature %q in PIN %q: $q"
                $char
                $.Params.pin
                $char_terc
              */}}
            {{ end }}
          </td>
          <td>{{ index $.card.chars $char }}</td>

          {{ range $comp := $.card.comps }}
            <td>{{ index $comp $char }}</td>
          {{ end }}
        </tr>
        {{ end }}
      </tbody>
      <tfoot>
        <tr>
          <th colspan="7">
            <a
              href="#post-table-{{ .card.card_num }}"
              type="button"
              class="btn btn-outline-dark mb-1 me-1"
            >
              <i class="bi bi-arrow-bar-down" aria-hidden="true"></i> Next section
            </a>
            <a
              href="#sale-characteristics-{{ .card.card_num }}"
              type="button"
              class="btn btn-outline-dark mb-1"
            >
              <i class="bi bi-arrow-bar-up" aria-hidden="true"></i> Previous section
            </a>
          </th>
        </tr>
      </tfoot>
    </table>

    <div id="post-table-{{ .card.card_num }}">
      {{ if .special_case_multi_card }}
      <p>
        <strong><span class="asterisk">*</span></strong> Since your home has
        {{ if eq (int .Params.meta_pin_num_cards) 2 }}
          two
        {{ else if eq (int .Params.meta_pin_num_cards) 3 }}
          three
        {{ else }}
          {{ .Params.meta_pin_num_cards }}
        {{ end }}
        cards, we estimate its value using
        a slightly different method than the one we use for other properties. For properties like this one, we use the characteristics of
        the largest card to estimate the property's value, but we adjust the building square footage of
        that card to use the combined building square footage of all cards on the
        property. The characteristics in the table above reflect this difference. For more information on multi-card value estimation, see our
        <a href="https://github.com/ccao-data/wiki/blob/master/Residential/Multi-Card%20PINs/multi_card_explainer.md" target="_blank">multi-card explainer</a>.
      </p>
      {{ end }}

      {{ if .card.has_subject_pin_sale }}
      <p>
        <strong><span class="asterisk">**</span></strong> This is a past sale of your home.
        The model usually considers past sales of a home to be important for its value,
        even if those sales are older than sales of other homes.
      </p>
      {{ end }}
    </div>
  </div>

  <h3 class="mb-3">
    Summary of the Top 5 Most Important Sales
  </h3>
  <p>
    The top five comparable sales took place
    {{ .card.comp_summary.sale_year_range_prefix }}
    <strong>{{ .card.comp_summary.sale_year_range }}</strong>.
    The average price of these sales was <strong>{{ .card.comp_summary.avg_sale_price }}</strong>
    at <strong>{{ .card.comp_summary.avg_price_per_sqft }}/sq.ft.</strong>
  </p>

  <h3 class="mb-3">Initial Model Estimate</h3>
  <p>
    Based on these and other sales, the model that ran on {{ .Params.final_model_run_date }}
    initially estimated that the value of
    {{ if and .is_multicard (not .special_case_multi_card) }}
      this card
    {{ else }}
      your home
    {{ end }}
    as of lien date <strong>January 1, {{ .Params.assessment_year }}</strong> should be
    <strong>{{ .card.pred_card_initial_fmv }}</strong> at
    <strong>{{ .card.pred_card_initial_fmv_per_sqft }}/sq.ft.</strong>
  </p>
  {{ end }}

  <!-- Load Bootstrap JS -->
  <script src="/static/js/jquery@3.7.1.min.js"></script>
  <script src="/static/js/bootstrap@5.3.7.bundle.min.js"></script>

  <!-- Load Leaflet JS -->
  <script src="/static/js/leaflet@1.9.4.min.js" ></script>

  <!-- Load DataTables JS -->
  <script src="/static/js/datatables@2.3.2.min.js"></script>

  <!-- Main script logic. -->
  <!-- There are two primary steps here: -->
  <!--   1. Initialize Leaflet maps and define interaction logic -->
  <!--   2. Initialize DataTables and define interaction logic -->
  <script>
    // Initialize an object to track map render metadata. This is important
    // because some elements of the maps, such as zoom level, need to be
    // set only once the map is displayed to the user, such as through
    // a tab selection in the multicard case
    const mapRegistry = {}; // cardIndex -> { map: ..., bounds: ..., fitDone: false }

    // Initialize maps once the DOM is loaded
    document.addEventListener("DOMContentLoaded", function() {
      {{/*
        Check if this is a large or old multicard, in which case the map and
        characteristic table will be tabbed, and we need to define extra
        logic to tweak element display when tabs change.

        We also want to only map the frankencard for small recent multicards
      */}}
      {{ $.Store.Set "map_is_tabbed" false }}
      {{ $.Store.Set "cards_to_map" (first 1 .Params.cards) }}
      {{ if $is_multicard }}
        {{ if $.Params.special_case_multi_card }}
          {{ $.Store.Set "map_is_tabbed" false }}
          {{ $.Store.Set "cards_to_map" (slice ($.Store.Get "frankencard")) }}
        {{ else }}
          {{ $.Store.Set "map_is_tabbed" true }}
          {{ $.Store.Set "cards_to_map" .Params.cards }}
        {{ end }}
      {{ end }}
      {{ $map_is_tabbed := $.Store.Get "map_is_tabbed" }}
      {{ $cards_to_map := $.Store.Get "cards_to_map" }}

      {{ range $index, $card := $cards_to_map }}
        initializeMap("{{ $card.card_num }}", {{ $index }});
        initializeTable(
          "{{ $card.card_num }}",
          {{ $index }},
          {{ $map_is_tabbed }}
        );
      {{ end }}
      renderMapsOnDisplay(mapRegistry, {{ $map_is_tabbed }});

      // Flip icons on collapsible infobox depending on whether the content is
      // shown or not
      $("#info-content").on("show.bs.collapse", function () {
        $("#info-caret").removeClass("bi-caret-down-fill").addClass("bi-caret-up-fill");
      });
      $("#info-content").on("hide.bs.collapse", function () {
        $("#info-caret").removeClass("bi-caret-up-fill").addClass("bi-caret-down-fill");
      });
    });

    // Fit map bounds only once they are visible. This is important because
    // the Leaflet fitBounds() call will only work if the map is visible,
    // but multi-card reports can have maps that are hidden until the
    // nav tab corresponding to their card is active
    function renderMapsOnDisplay(mapRegistry, isTabbed) {
      // Map rendering only needs to be adjusted if the map is contained in
      // a tabset, so treat this function as a noop otherwise
      if (isTabbed) {
        // Trigger a map fitBounds() call when a new card tab is shown.
        // Note that this means that any zooming a user does will be reset
        // any time they switch card tabs, which may not be desirable
        $('#propertyCardTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
          const tabId = $(e.target).attr('id');
          const entry = mapRegistry[tabId];

          if (entry) {
            entry.map.invalidateSize();
            entry.map.fitBounds(entry.bounds);
          } else {
            // Print some debugging info if the map metadata does not exist
            console.log(`No map registry entry for ${tabId}`);
            console.log(`Map registry object:`);
            console.log(mapRegistry);
          }
        });
      }
    }

    // Initialize map for a specific card
    function initializeMap(cardNum, cardIndex) {
      const pin = {{ .Params.pin }};
      const pinPretty = {{ .Params.pin_pretty }};
      const mapData = {{ .Params.cards }};
      const cardData = mapData[cardIndex];
      const specialMulti = {{ if .Params.special_case_multi_card }}true{{ else }}false{{ end }};

      // Create map centered on subject property
      const map = L.map(
        `map-${cardNum}`,
        {
          // Disable single-finger scroll interactions on mobile. Because
          // touchZoom is enabled by default, the user will still be able to
          // use two fingers to scroll and zoom
          dragging: !L.Browser.mobile,
          tap: !L.Browser.mobile
        }
      ).setView(
        [cardData.location.loc_latitude, cardData.location.loc_longitude],
        14
      );

      // Add tile layer
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          maxZoom: 19
        }
      ).addTo(map);

      // Add subject property marker
      const subjectMarker = L.circleMarker(
        [cardData.location.loc_latitude, cardData.location.loc_longitude],
        {
          radius: 5,
          color: "black",
          weight: 2,
          fill: false,
          fillOpacity: 0
        }
      ).addTo(map);

      // Prepare bounds to fit all markers
      const bounds = L.latLngBounds();
      bounds.extend([cardData.location.loc_latitude, cardData.location.loc_longitude]);

      // Add subject property label and popup
      let hasSubjectSale = false;

      // Check if subject property is also a comp
      cardData.comps.forEach(comp => {
        if (comp.is_subject_pin_sale) {
          hasSubjectSale = true;
        }
      });

      if (!hasSubjectSale) {
        const propertyLabel = cardData.is_multicard ? "Subject card" : "Your home";
        subjectMarker.bindTooltip(
          propertyLabel,
          {
            permanent: true,
            // Propagate click events from the marker to its tooltip so that
            // users can open the detail popup by clicking on the tooltip.
            // This is particularly helpful on mobile since it can be hard
            // to tap precisely on the circle marker
            interactive: true,
            direction: "top",
            offset: [0, -4],
            className: "subject-tooltip"
          }
        );

        // Define subjectPopupContent dynamically depending on 2-3 card case
        const bldgLabel = specialMulti ? "Combined Bldg. Sq. Ft." : "Bldg S.F.";
        const bldgValue = specialMulti ? cardData.chars.combined_bldg_sf : cardData.chars.char_bldg_sf;

        // Create popup content
        const subjectPopupContent = `
          <h5>${propertyLabel}</h5>
          <b>Address</b>: ${cardData.location.property_address}
          <br><b>PIN</b>: <a href="https:\/\/www.cookcountyassessor.com/pin/${pin}" target="_blank">${pinPretty}</a>
          <br><b>Property class</b>: ${cardData.chars.char_class}
          <br><b>Assessor neighborhood</b>: ${cardData.location.meta_nbhd_code}
          <br><b>Year built</b>: ${cardData.chars.char_yrblt}
          <br><b>${bldgLabel}</b>: ${bldgValue}
          <br><b>Land S.F.</b>: ${cardData.chars.char_land_sf}
          <br><b>Beds</b>: ${cardData.chars.char_beds}
          <br><b>Full baths</b>: ${cardData.chars.char_fbath}
          <br><b>Half baths</b>: ${cardData.chars.char_hbath}
        `;

        subjectMarker.bindPopup(subjectPopupContent);
      }

      // Add comp markers
      cardData.comps.forEach(comp => {
        const compMarker = L.circleMarker(
          [comp.loc_latitude, comp.loc_longitude],
          {
            radius: 4,
            color: "#00cc00",
            fillOpacity: 1,
            opacity: comp.is_subject_pin_sale ? 0 : 1 // Hide the marker if it's a subject PIN sale
          }
        ).addTo(map);

        const compBldgLabel = specialMulti ? "Combined Bldg. Sq. Ft." : "Bldg S.F.";
        const compBldgValue = specialMulti ? comp.combined_bldg_sf : comp.char_bldg_sf;
        // Add tooltip
        const tooltipText = comp.is_subject_pin_sale
          ? `${cardData.is_multicard ? "Subject card" : "Subject property"} [${comp.sale_price_short} (${comp.sale_date})]`
          : `${comp.sale_price_short} (${comp.sale_date})`;

        compMarker.bindTooltip(
          tooltipText,
          {
            permanent: true,
            interactive: true,
            direction: "top",
            offset: [0, -4],
            className: "comp-tooltip"
          }
        );

        // Create popup content
        const compPopupContent = `
          <h5>${comp.is_subject_pin_sale ? (cardData.is_multicard ? "Subject card" : "Subject property") : "Sale " + comp.comp_num}</h5>
          <b>Address</b>: ${comp.property_address}
          <br><b>PIN</b>: <a href="https:\/\/www.cookcountyassessor.com/pin/${comp.pin}" target="_blank">${comp.pin_pretty}</a>
          <br><b>Property class</b>: ${comp.char_class}
          <br><b>Assessor neighborhood</b>: ${comp.meta_nbhd_code}
          <br><b>Sale price</b>: ${comp.sale_price}
          <br><b>Sale $/sqft</b>: ${comp.sale_price_per_sq_ft}
          <br><b>Sale date</b>: ${comp.sale_date}
          <br><b>Sale doc. num.</b>: ${comp.document_num}
          <br><b>Year built</b>: ${comp.char_yrblt}
          <br><b>${compBldgLabel}</b>: ${compBldgValue}
          <br><b>Land S.F.</b>: ${comp.char_land_sf}
          <br><b>Beds</b>: ${comp.char_beds}
          <br><b>Full baths</b>: ${comp.char_fbath}
          <br><b>Half baths</b>: ${comp.char_hbath}
        `;

        compMarker.bindPopup(compPopupContent);

        // Add to bounds
        bounds.extend([comp.loc_latitude, comp.loc_longitude]);
      });

      // Add legend
      const legend = L.control({ position: "bottomright" });
      legend.onAdd = function() {
        const div = L.DomUtil.create("div", "info legend");
        div.innerHTML = `
          <div style="background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
            <div style="margin-bottom: 5px;">
              <span style="display: inline-block; width: 13px; height: 13px; border-radius: 50%; border: 2px solid black; margin-right: 5px;"></span>
              ${cardData.is_multicard ? "Subject card" : "Your home"}
            </div>
            <div>
              <span style="display: inline-block; width: 13px; height: 13px; border-radius: 50%; background-color: #00cc00; margin-right: 5px;"></span>
              Comparable sale
            </div>
          </div>
        `;
        return div;
      };
      legend.addTo(map);

      // Add note control on mobile with prompt to use two fingers on the map
      if (L.Browser.mobile) {
        const noteControl = L.control({ position: "topright" });
        noteControl.onAdd = function() {
          const div = L.DomUtil.create("div", "info note");
          div.innerHTML = `
            <div style="background-color: white; padding: 5px 10px; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2);">
              Use two fingers to scroll or zoom the map
            </div>
          `;
          return div;
        };
        noteControl.addTo(map);
      }

      // Hide the note control whenever a popup is displayed, since otherwise
      // the note control can obscure the popup
      const noteControlDiv = document.querySelector(".leaflet-control.info.note");
      map.on("popupopen", function() {
        if (noteControlDiv) noteControlDiv.style.display = "none";
      }).on("popupclose", function() {
        if (noteControlDiv) noteControlDiv.style.display = "";
      });

      // Fit bounds with a small buffer
      const boundsPadding = 0.001;
      bounds._southWest.lat -= boundsPadding;
      bounds._southWest.lng -= boundsPadding;
      bounds._northEast.lat += boundsPadding;
      bounds._northEast.lng += boundsPadding;

      // Update the map registry with metadata about this map
      mapRegistry[`card-${cardIndex}-tab`] = {
        map: map,
        bounds: bounds,
      };

      // In the multicard case, fitting the bounds will only work for the first
      // card, which is the only one that will be visible in the page at
      // the time of initialization. That's fine because our `shown.bs.tab`
      // event handler defined in the `renderMapsOnDisplay` function will fit
      // the bounds for all subsequent cards when the user selects their tab
      map.fitBounds(bounds);
    }

    // Initialize the characteristic comparison table
    function initializeTable(cardNum, cardIndex, isTabbed) {
      const $table = $(`#comp-table-${cardNum}`);
      const dt = $table.DataTable({
        responsive: true,  // Fold extra columns into row dropdown on small viewports
        paging: false,  // Disable pagination to display all chars at once
        scrollCollapse: true,  // Collapse the table size below the fixed height when there are few rows
        fixedHeader: {
          header: true,  // Make the header row sticky during scroll
          footer: true  // Make the footer sticky during scroll
        },
        searching: true,  // Enable a search box to filter rows
        info: true,  // Enable info text (defined under the `language` key below)
        order: [], // Disable ordering on initialization to use the same order as the HTML table
        columnDefs: [
          {
            targets: `#comp-table-score-col-${cardNum}`,  // Rank column
            className: "dt-left",  // Force left alignment, since numeric cols are right aligned by default
            orderable: true,  // Redundant with data-orderable above, but duplicated here for clarity
          },
        ],
        language: {  // Custom text
          search: "<i class='bi bi-search' aria-hidden='true'></i> <b>Search</b> characteristics:",  // Search input label
          info: "",
          infoFiltered: "",  // Disable searched row count text
          infoEmpty: "",  // Disable text that shows when no rows match search
        },
        buttons: [
          {
            extend: "collection",  // Dropdown with selection of buttons
            text: '<i class="bi bi-file-earmark-arrow-down"></i> Export ',
            className: "btn btn-outline-dark",
            autoClose: true,  // Automatically close when an option is clicked
            fade: 50,  // Faster open/close animation
            attr: {
              class: "btn btn-outline-dark buttons-collection"
            },
            buttons: [
              {
                extend: "copy",  // Button to copy table to clipboard
                text: '<i class="bi bi-clipboard"></i> Copy',
                footer: false  // Exclude table footer from export
              },
              {
                extend: "csv",  // Button to export table as CSV
                text: '<i class="bi bi-file-earmark-spreadsheet"></i> Excel',
                footer: false
              },
              {
                extend: "print",  // Button to open a print view for the table
                text: '<i class="bi bi-printer"></i> Print View',
                footer: false,
                autoPrint: false  // Don't open print dialog box automatically
              }
            ]
          },
        ],
        layout: {
          topStart: "search",
          topEnd: "buttons",
        }
      });

      // The `fixedHeader` plugin seems to neglect to disable the sticky footer
      // when switching between Bootstrap tabsets. The following code fixes that
      // bug by hooking into the tabset events to manually enable and disable
      // sticky headers and footers when switching tabs
      if (isTabbed) {
        // On initial render, all sticky headers and footers except the first
        // table should be disabled
        if (cardIndex !== 0) {
          dt.fixedHeader.disable();
        }

        // Enable sticky headers and footers when showing a tab, and disable
        // when hiding the tab
        $(`#card-${cardIndex}-tab`).on("show.bs.tab", function(event) {
          dt.fixedHeader.enable();
        });
        $(`#card-${cardIndex}-tab`).on("hide.bs.tab", function(event) {
          dt.fixedHeader.disable();
        });
      }
    }
  </script>
</body>
</html>
